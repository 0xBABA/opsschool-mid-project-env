---
- name: download prometheus tarball
  get_url:
    url: https://github.com/prometheus/prometheus/releases/download/v{{prometheus_ver}}/prometheus-{{prometheus_ver}}.linux-amd64.tar.gz
    dest: /tmp/prometheus-{{ prometheus_ver }}.linux-amd64.tar.gz
  tags: 
    - include_prometheus_role

- name: untar prometheus tarball
  unarchive:
    src: /tmp/prometheus-{{ prometheus_ver }}.linux-amd64.tar.gz
    dest: /tmp
    remote_src: yes
  tags: 
    - include_prometheus_role

- name: create prometheus group
  group:
    name: prometheus
    system: yes
  tags: 
    - include_prometheus_role

- name: create prometheus user
  user:
    name: prometheus
    create_home: no
    system: yes
    group: prometheus
  tags:
    - include_prometheus_role

- name: create configuration and data directories
  file:
    path: "{{ item }}"
    state: directory
    owner: prometheus
    group: prometheus
    mode: "0775"
  loop:
    - /etc/prometheus/rules
    - /etc/prometheus/rules.d
    - /etc/prometheus/files_sd
    - /var/lib/prometheus
  tags:
    - include_prometheus_role

- name: copy prometheus binary to be under PATH
  copy:
    src: /tmp/prometheus-{{ prometheus_ver }}.linux-amd64/{{item}}
    dest: /usr/local/bin
    owner: prometheus
    group: prometheus
    mode: '0744'
    remote_src: yes
  loop:
    - prometheus
    - promtool
  tags:
    - include_prometheus_role

- name: copy consoles and console_libraries to config directory
  copy: 
    src: /tmp/prometheus-{{ prometheus_ver }}.linux-amd64/{{item}}
    dest: /etc/prometheus
    owner: prometheus
    group: prometheus
    mode: '0744'
    remote_src: yes
  loop:
    - consoles
    - console_libraries
  tags:
    - include_prometheus_role

- name: copy prometheus service file
  copy:
    src: ./files/prometheus.service
    dest: /etc/systemd/system/prometheus.service
    group: prometheus
    owner: prometheus
  tags:
    - include_prometheus_role

- name: copy prometheus configuration file
  copy:
    src: ./files/prometheus.yml
    dest: /etc/prometheus
    group: prometheus
    owner: prometheus
  tags:
    - include_prometheus_role
    - configure_prometheus

- name: start promtheus service
  systemd:
    daemon_reload: yes
    name: prometheus
    enabled: yes
    state: restarted
  tags:
    - include_prometheus_role
    - configure_prometheus

- name: add grafana's official GPG key
  apt_key:
    url: https://packages.grafana.com/gpg.key
    state: present
  tags:
    - install_grafana

- name: add grafana stable repository to apt
  apt_repository:
    repo: "deb https://packages.grafana.com/oss/deb stable main"
    state: present
  tags:
    - install_grafana

- name: update apt package index and install dependencies
  apt:
    name: 
    - grafana
    state: latest
    update_cache: yes
  tags:
    - install_grafana 

- name: start grafana service
  systemd:
    daemon_reload: yes
    name: grafana-server
    enabled: yes
    state: restarted
  tags:
    - install_grafana

- name: get prometheus service status
  systemd:
    name: prometheus
  register: prometheus_service_status
  tags:
    - include_prometheus_role

- debug:
    var: prometheus_service_status.status.ActiveState
  tags:
    - include_prometheus_role

- name: get grafana service status
  systemd:
    name: grafana-server
  register: grafana_service_status
  tags:
    - install_grafana

- debug:
    var: grafana_service_status.status.ActiveState
  tags:
    - install_grafana

- name: copy prometheus consul service file
  copy:
    src: ./files/prometheus-consul-service.json
    dest: /etc/consul.d/
    group: consul
    owner: consul
  notify:
    - restart consul service
  tags:
    - include_prometheus_role